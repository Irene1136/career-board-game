<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç‰¹æ•™è·æ¶¯è›‡æ¢¯ 0-100 æ­²ç‰ˆ v5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: radial-gradient(circle at top, #bfdbfe, #eff6ff 40%, #f9fafb 80%);
      color: #0f172a;
    }
    h1, h2, h3 { margin: 0.4em 0; }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: 18px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
      box-shadow: 0 10px 25px rgba(15,23,42,0.15);
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(96,165,250,0.18), transparent 55%);
      pointer-events: none;
    }
    .card-content {
      position: relative;
      z-index: 1;
    }

    .flex { display: flex; gap: 16px; }
    .flex-wrap { flex-wrap: wrap; }
    .flex-1 { flex: 1; }
    .flex-2 { flex: 2; }

    label {
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
      background: #f8fafc;
    }
    input[type="file"] {
      font-size: 12px;
    }
    textarea { min-height: 120px; resize: vertical; }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 6px;
      margin-right: 8px;
      background: linear-gradient(135deg, #2563eb, #38bdf8);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(37,99,235,0.5);
    }
    .btn.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }
    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
      box-shadow: none;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .section-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
      border-left: 4px solid #2563eb;
      padding-left: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e0f2fe;
      color: #0369a1;
    }

    /* æ£‹ç›¤ï¼š10x10ï¼Œè›‡æ¢¯ 100 æ ¼ */
    .board-grid {
      display: grid;
      grid-template-columns: repeat(10, minmax(0, 1fr));
      grid-auto-rows: 80px;
      gap: 4px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background: radial-gradient(circle at center, #e0f2fe, #bfdbfe);
      border-radius: 22px;
      padding: 8px;
      box-shadow: inset 0 0 18px rgba(15,23,42,0.25);
    }
    .board-cell {
      background: rgba(255,255,255,0.94);
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 4px;
      font-size: 10px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow: visible; /* è®“æ£‹å­å¯ä»¥ã€Œè“‹éã€é‚Šç•Œ */
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out;
    }
    .board-cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(15,23,42,0.25);
    }
    .tile-number {
      position:absolute;
      top:2px;
      right:4px;
      font-size:10px;
      opacity:0.7;
      z-index:1;
    }
    .tile-category {
      font-weight:700;
      margin-bottom:2px;
      font-size:11px;
      position:relative;
      z-index:1;
    }
    .tile-type {
      font-size:9px;
      opacity:0.7;
      position:relative;
      z-index:1;
    }

    .token-wrap {
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:5;        /* æ£‹å­æ°¸é åœ¨æœ€ä¸Šå±¤ */
      pointer-events:none;
    }
    .token {
      width:40px;
      height:40px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      box-shadow:0 2px 8px rgba(15,23,42,0.4);
      border:2px solid #fff;
      overflow:hidden;
      background:#eff6ff;
    }
    .token img {
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:12px;
    }

    .players-list table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .players-list th, .players-list td {
      border-bottom: 1px solid #e5e7eb;
      padding: 4px 6px;
      text-align: left;
    }
    .players-list th {
      background: #eff6ff;
      font-weight: 600;
    }

    .log {
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 6px;
      background: #f9fafb;
    }

    /* çµæŸç•«é¢ */
    .result-player {
      border-radius: 14px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      padding:8px 10px;
      margin-bottom:8px;
    }
    .result-player h3 {
      font-size:14px;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .result-player ul {
      margin:4px 0 0 18px;
      padding:0;
      font-size:12px;
    }

    /* éª°å­å‹•ç•« overlay */
    #diceOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,0.35);
      z-index: 50;
    }
    .dice-popup {
      width: 130px;
      height: 130px;
      border-radius: 30px;
      background: radial-gradient(circle at top, #fee2e2, #fecaca);
      box-shadow: 0 14px 32px rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 58px;
      font-weight: 800;
      color: #b91c1c;
      border: 4px solid #f97373;
      animation: pop 0.4s ease-out;
    }
    @keyframes pop {
      from { transform: scale(0.5); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }

    /* RPG æœ¨é ­é¢¨ modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      background: rgba(15,23,42,0.4);
      z-index: 60;
    }
    .modal-card {
      width: min(90%, 440px);
      background:
        linear-gradient(135deg,#b45309,#78350f) border-box,
        repeating-linear-gradient(135deg,#f5f5f4,#e7e5e4 6px,#d6d3d1 6px,#d6d3d1 12px) padding-box;
      border-radius: 22px;
      padding: 12px 14px 10px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.6);
      border: 3px solid #78350f;
      animation: pop 0.25s ease-out;
      color:#111827;
    }
    .modal-inner {
      background: radial-gradient(circle at top,#fefce8,#fafaf9);
      border-radius: 16px;
      padding: 10px 12px 8px;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.13);
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .modal-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #facc15;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }
    .modal-title {
      font-weight: 700;
      font-size: 16px;
    }
    .modal-body {
      font-size: 13px;
      color: #374151;
      margin-bottom: 8px;
    }
    .modal-body p { margin: 4px 0; }

    .modal-image {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      background: #fed7aa;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:42px;
      margin-bottom:4px;
      box-shadow:0 3px 8px rgba(0,0,0,0.25);
    }

    .modal-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
    }
    .modal-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .modal-btn.primary {
      background: linear-gradient(135deg,#2563eb,#38bdf8);
      color:#fff;
      box-shadow:0 3px 8px rgba(37,99,235,0.5);
    }
    .modal-btn.secondary {
      background:#e5e7eb;
      color:#111827;
    }
    .modal-btn.option {
      flex: 1 1 100%;
      justify-content: flex-start;
      background:#fee2e2;
      color:#1f2937;
      border:1px solid #f97316;
    }
    .modal-btn.option:hover {
      background:#fed7aa;
    }

    @media (max-width: 960px) {
      .flex { flex-direction: column; }
      .board-grid {
        grid-auto-rows: 70px;
        max-width: 100%;
      }
      .token { width:30px;height:30px;font-size:18px; }
    }
  </style>
</head>
<body>
<div class="app-container">

  <!-- è¨­å®šç•«é¢ -->
  <div class="card" id="setup-card">
    <div class="card-content">
      <h1>ğŸ“ ç‰¹æ•™è·æ¶¯è›‡æ¢¯ Â· 0â€“100 æ­²ç‰ˆ v5</h1>
      <p style="font-size:13px;color:#6b7280;margin-bottom:10px;">
        è±¡å¾µäººç”Ÿ 0ï½100 æ­²ï¼Œä¸€æ­¥ä¸€æ­¥çˆ¬ä¸Šè·æ¶¯çš„æ¢¯å­ï¼Œä¹Ÿå¯èƒ½é‡åˆ°è®“ä½ å¾€ä¸‹æ»‘çš„ã€Œé¸æ“‡ã€ã€‚<br>
        æ­¥é©Ÿï¼šâ‘  è¨­å®šç©å®¶ï¼†é ­åƒ â†’ â‘¡ é¡Œåº«ï¼ˆå¯åŒ¯å…¥ï¼‰â†’ â‘¢ é–‹å§‹éŠæˆ² ğŸ²
      </p>

      <div class="flex flex-wrap">
        <div class="flex-1">
          <div class="section-title">
            ç©å®¶è¨­å®š
            <span class="pill">2ï½8 äºº</span>
          </div>

          <label for="playerCount">ç©å®¶äººæ•¸</label>
          <select id="playerCount">
            <option value="2">2 äºº</option>
            <option value="3">3 äºº</option>
            <option value="4">4 äºº</option>
            <option value="5">5 äºº</option>
            <option value="6">6 äºº</option>
            <option value="7">7 äºº</option>
            <option value="8">8 äºº</option>
          </select>

          <div id="playerInputs" style="margin-top:8px;"></div>

          <button class="btn" id="startGameBtn" style="margin-top:10px;">
            ğŸš€ é–‹å§‹éŠæˆ²
          </button>
          <button class="btn secondary" id="loadSavedGameBtn" style="margin-top:10px;display:none;">
            ğŸ” è¼‰å…¥ä¸Šæ¬¡éŠæˆ²
          </button>
        </div>

        <div class="flex-1">
          <div class="section-title">
            é¡Œåº«è¨­å®š
            <span class="pill">é¡Œç›®éœ€æ¨™ç¤ºè·ç¾¤é¡åˆ¥</span>
          </div>
          <p style="font-size:12px;color:#6b7280;margin:4px 0;">
            æ¯é¡Œæ ¼å¼ï¼š<br>
            <code>é¡Œç›®ï½œé¸é …Aï½œé¸é …Bï½œé¸é …Cï½œé¸é …Dï½œæ­£ç¢ºç­”æ¡ˆï½œè·ç¾¤åˆ†é¡</code><br>
            è·ç¾¤åˆ†é¡éœ€ç‚ºï¼šæ©Ÿæ¢°ç¾¤ã€å‹•åŠ›æ©Ÿæ¢°ç¾¤ã€é›»æ©Ÿèˆ‡é›»å­ç¾¤ã€åŒ–å·¥ç¾¤ã€åœŸæœ¨èˆ‡å»ºç¯‰ç¾¤ã€å•†æ¥­èˆ‡ç®¡ç†ç¾¤ã€å¤–èªç¾¤ã€è¨­è¨ˆç¾¤ã€è¾²æ¥­ç¾¤ã€é£Ÿå“ç¾¤ã€å®¶æ”¿ç¾¤ã€é¤æ—…ç¾¤ã€æµ·äº‹ç¾¤ã€æ°´ç”¢ç¾¤ã€è³‡è¨Šç¾¤ã€‚
          </p>
          <textarea id="questionInput"></textarea>
          <div style="margin-top:6px;">
            <button class="btn secondary small" id="loadSampleQuestionsBtn">ğŸ“š è¼‰å…¥ç¤ºç¯„é¡Œåº«</button>
          </div>
          <div style="margin-top:6px;font-size:12px;">
            <input type="file" id="questionFileInput" accept=".csv,text/csv" />
            <div style="color:#6b7280;margin-top:2px;">
              â€» Excelï¼šè«‹å°‡æ¬„ä½ä¾åºæ’æˆï¼šé¡Œç›®,é¸é …A,é¸é …B,é¸é …C,é¸é …D,æ­£ç¢ºç­”æ¡ˆ,è·ç¾¤åˆ†é¡ï¼Œå†å¦å­˜ç‚º CSV ä¸Šå‚³ã€‚
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div class="card" id="game-card" style="display:none;">
    <div class="card-content">
      <div class="flex flex-wrap">
        <div class="flex-2">
          <div class="section-title">
            ğŸ—ºï¸ 0ï½100 æ­²è·æ¶¯è›‡æ¢¯æ£‹ç›¤
            <span class="pill">é»è·ç¾¤æ ¼å¯çœ‹ä»‹ç´¹èˆ‡æŠ€èƒ½</span>
          </div>
          <div id="board" class="board-grid"></div>
        </div>

        <div class="flex-1">
          <div class="section-title">ç©å®¶ç‹€æ…‹</div>
          <div id="currentTurn" style="font-size:14px;margin-bottom:6px;font-weight:700;"></div>

          <div class="players-list">
            <table>
              <thead>
                <tr>
                  <th>é ­åƒ</th>
                  <th>ç©å®¶</th>
                  <th>ä½ç½®</th>
                  <th>è·æ¶¯åˆ†æ•¸</th>
                </tr>
              </thead>
              <tbody id="playersTableBody"></tbody>
            </table>
          </div>

          <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;">
            <button class="btn" id="rollDiceBtn">ğŸ² æ“²éª°å­</button>
            <button class="btn secondary small" id="saveGameBtn">ğŸ’¾ å„²å­˜é€²åº¦</button>
          </div>

          <div style="margin-top:12px;">
            <div class="section-title">
              éŠæˆ²ç´€éŒ„
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:4px;">
              <span>é¡¯ç¤ºï¼š</span>
              <select id="logFilterSelect">
                <option value="all">å…¨éƒ¨ç©å®¶</option>
              </select>
            </div>
            <div id="log" class="log"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- çµæŸç¸½çµç•«é¢ -->
  <div class="card" id="result-card" style="display:none;">
    <div class="card-content">
      <h2>ğŸ éŠæˆ²çµæŸç¸½çµ</h2>
      <p style="font-size:13px;color:#6b7280;margin-bottom:8px;">
        å¯ä»¥è«‹æ¯ä½å­¸ç”Ÿå›é¡§ã€Œè‡ªå·±äººç”Ÿï¼è·æ¶¯è·¯ä¸Šåšéå“ªäº›é¸æ“‡ã€ï¼Œå¾äº‹ä»¶ä¸­æ‰¾åˆ°ä¸‹ä¸€æ­¥çš„æ–¹å‘ã€‚
      </p>
      <div id="resultContent"></div>
    </div>
  </div>

</div>

<!-- éª°å­å‹•ç•« overlay -->
<div id="diceOverlay">
  <div class="dice-popup" id="dicePopup">1</div>
</div>

<!-- RPG æœ¨é ­é¢¨ Modal -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-inner">
      <div class="modal-header">
        <div class="modal-icon" id="modalIcon">ğŸ´</div>
        <div class="modal-title" id="modalTitle">æ¨™é¡Œ</div>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-buttons" id="modalButtons"></div>
    </div>
  </div>
</div>

<script>
  // ================== åŸºæœ¬è³‡æ–™ ==================
  const GROUPS = [
    "æ©Ÿæ¢°ç¾¤",
    "å‹•åŠ›æ©Ÿæ¢°ç¾¤",
    "é›»æ©Ÿèˆ‡é›»å­ç¾¤",
    "åŒ–å·¥ç¾¤",
    "åœŸæœ¨èˆ‡å»ºç¯‰ç¾¤",
    "å•†æ¥­èˆ‡ç®¡ç†ç¾¤",
    "å¤–èªç¾¤",
    "è¨­è¨ˆç¾¤",
    "è¾²æ¥­ç¾¤",
    "é£Ÿå“ç¾¤",
    "å®¶æ”¿ç¾¤",
    "é¤æ—…ç¾¤",
    "æµ·äº‹ç¾¤",
    "æ°´ç”¢ç¾¤",
    "è³‡è¨Šç¾¤"
  ];

  const groupEmoji = {
    "æ©Ÿæ¢°ç¾¤":"âš™ï¸",
    "å‹•åŠ›æ©Ÿæ¢°ç¾¤":"ğŸšœ",
    "é›»æ©Ÿèˆ‡é›»å­ç¾¤":"ğŸ”Œ",
    "åŒ–å·¥ç¾¤":"ğŸ§ª",
    "åœŸæœ¨èˆ‡å»ºç¯‰ç¾¤":"ğŸ—ï¸",
    "å•†æ¥­èˆ‡ç®¡ç†ç¾¤":"ğŸ›’",
    "å¤–èªç¾¤":"ğŸ—£ï¸",
    "è¨­è¨ˆç¾¤":"ğŸ¨",
    "è¾²æ¥­ç¾¤":"ğŸŒ¾",
    "é£Ÿå“ç¾¤":"ğŸ",
    "å®¶æ”¿ç¾¤":"ğŸ ",
    "é¤æ—…ç¾¤":"ğŸ½ï¸",
    "æµ·äº‹ç¾¤":"ğŸš¢",
    "æ°´ç”¢ç¾¤":"ğŸŸ",
    "è³‡è¨Šç¾¤":"ğŸ’»"
  };

  const groupInfo = {
    "æ©Ÿæ¢°ç¾¤": {
      desc: "å­¸ç¿’æ“ä½œèˆ‡ç¶­ä¿®å„ç¨®æ©Ÿæ¢°è¨­å‚™ï¼Œä¾‹å¦‚è»ŠåºŠã€éŠ‘åºŠã€CNCï¼ŒåŠ å·¥é‡‘å±¬é›¶ä»¶ã€‚",
      skills: ["é–±è®€æ©Ÿæ¢°åœ–", "ä½¿ç”¨é‡æ¸¬å·¥å…·", "å®‰å…¨æ“ä½œæ©Ÿå°", "ç´°å¿ƒèˆ‡è€å¿ƒ"]
    },
    "å‹•åŠ›æ©Ÿæ¢°ç¾¤": {
      desc: "èˆ‡æ±½è»Šã€æ©Ÿè»Šã€è¾²ç”¨æ©Ÿæ¢°ç­‰å¼•æ“è¨­å‚™æœ‰é—œçš„ä¿®è­·èˆ‡æª¢ä¿®ã€‚",
      skills: ["äº†è§£å¼•æ“åŸç†", "ç¶­ä¿®èˆ‡æ‹†è£", "æ•…éšœæ’é™¤", "é‡è¦–å®‰å…¨"]
    },
    "é›»æ©Ÿèˆ‡é›»å­ç¾¤": {
      desc: "å¾äº‹é›»è·¯é…ç·šã€é›»å™¨è¨­å‚™ç¶­è­·èˆ‡é›»å­ç”¢å“ç›¸é—œå·¥ä½œã€‚",
      skills: ["é–±è®€é›»è·¯åœ–", "ç„Šæ¥èˆ‡é…ç·š", "é›»è·¯æª¢æ¸¬", "æ³¨æ„ç´°ç¯€èˆ‡å®‰å…¨æ„è­˜"]
    },
    "åŒ–å·¥ç¾¤": {
      desc: "åœ¨åŒ–å­¸å·¥å» æˆ–å¯¦é©—å®¤è™•ç†è—¥å“ã€ç›£æ§åŒ–å­¸åæ‡‰èˆ‡è£½ç¨‹ã€‚",
      skills: ["éµå®ˆå®‰å…¨é˜²è­·", "åŸºæœ¬åŒ–å­¸çŸ¥è­˜", "æ“ä½œå„€å™¨è¨­å‚™", "ç´°å¿ƒç´€éŒ„æ•¸æ“š"]
    },
    "åœŸæœ¨èˆ‡å»ºç¯‰ç¾¤": {
      desc: "åƒèˆ‡æˆ¿å±‹ã€é“è·¯ã€æ©‹æ¢ç­‰å·¥ç¨‹è¦åŠƒèˆ‡æ–½å·¥ã€‚",
      skills: ["çœ‹æ‡‚åœ–é¢", "åŸºæœ¬ä¸ˆé‡æŠ€èƒ½", "ç¾å ´å®‰å…¨è§€å¿µ", "åœ˜éšŠåˆä½œ"]
    },
    "å•†æ¥­èˆ‡ç®¡ç†ç¾¤": {
      desc: "å¾äº‹é–€å¸‚æœå‹™ã€è¡ŒéŠ·ã€è¡Œæ”¿æ”¯æ´èˆ‡ä¼æ¥­ç®¡ç†ç›¸é—œå·¥ä½œã€‚",
      skills: ["é¡§å®¢æœå‹™", "æ”¶éŠ€èˆ‡è¨˜å¸³", "æºé€šè¡¨é”", "è² è²¬èˆ‡å®ˆæ™‚"]
    },
    "å¤–èªç¾¤": {
      desc: "é‹ç”¨èªè¨€èˆ‡ä¸åŒåœ‹å®¶çš„äººæºé€šï¼Œå¾äº‹æ—…éŠã€è²¿æ˜“ç­‰å·¥ä½œã€‚",
      skills: ["è½èªªè®€å¯«èƒ½åŠ›", "æ–‡åŒ–ç†è§£", "æºé€šèƒ½åŠ›", "å‹‡æ–¼é–‹å£"]
    },
    "è¨­è¨ˆç¾¤": {
      desc: "è¨­è¨ˆæµ·å ±ã€LOGOã€ç”¢å“åŒ…è£æˆ–å‹•ç•«ç­‰è¦–è¦ºä½œå“ã€‚",
      skills: ["ç¾æ„Ÿèˆ‡é…è‰²", "ä½¿ç”¨ç¹ªåœ–è»Ÿé«”", "å‰µæ„ç™¼æƒ³", "è€å¿ƒä¿®æ”¹ä½œå“"]
    },
    "è¾²æ¥­ç¾¤": {
      desc: "å¾äº‹ä½œç‰©æ ½åŸ¹ã€æº«å®¤ç®¡ç†èˆ‡æ™ºæ…§è¾²æ¥­ç›¸é—œå·¥ä½œã€‚",
      skills: ["æ¤ç‰©ç…§é¡§", "è§€å¯Ÿå¤©æ°£èˆ‡ç’°å¢ƒ", "æ“ä½œè¾²æ©Ÿè¨­å‚™", "è€å‹èˆ‡ç´°å¿ƒ"]
    },
    "é£Ÿå“ç¾¤": {
      desc: "è£½ä½œåŠ å·¥é£Ÿå“ã€å“ç®¡æª¢é©—èˆ‡é£Ÿå“å®‰å…¨ç®¡ç†ã€‚",
      skills: ["è¡›ç”Ÿè§€å¿µ", "èªè­˜é£Ÿæèˆ‡æ·»åŠ ç‰©", "æª¢é©—èˆ‡ç´€éŒ„", "åœ˜éšŠåˆä½œ"]
    },
    "å®¶æ”¿ç¾¤": {
      desc: "å­¸ç¿’å±…å®¶ç®¡ç†ã€é£²é£Ÿç‡Ÿé¤Šã€å¹¼å…’ç…§é¡§èˆ‡ç”Ÿæ´»ç†è²¡ã€‚",
      skills: ["æ•´ç†èˆ‡æ”¶ç´", "ç°¡æ˜“çƒ¹é£ªèˆ‡ç‡Ÿé¤Š", "ç…§é¡§å®¶äºº", "ç†è²¡è¦åŠƒ"]
    },
    "é¤æ—…ç¾¤": {
      desc: "åœ¨é¤å»³æˆ–æ—…é¤¨æä¾›é¤é£²æœå‹™èˆ‡æ—…éŠæ¥å¾…ã€‚",
      skills: ["åŸºæœ¬æ–™ç†èˆ‡é¤é£²æœå‹™", "è¦ªåˆ‡ç¦®è²Œ", "åœ˜éšŠåˆä½œ", "æŠ—å£“åŠ›"]
    },
    "æµ·äº‹ç¾¤": {
      desc: "èˆªæµ·ã€èˆ¹èˆ¶ç®¡ç†èˆ‡æµ·ä¸Šé‹è¼¸ç›¸é—œå·¥ä½œã€‚",
      skills: ["é–±è®€èˆªæµ·åœ–", "èˆ¹èˆ¶è¨­å‚™æ“ä½œ", "ç´€å¾‹èˆ‡é«”åŠ›", "é¢å°é¢¨æµªçš„å‹‡æ°£"]
    },
    "æ°´ç”¢ç¾¤": {
      desc: "é­šé¡èˆ‡æ°´ç”¢çš„é¤Šæ®–ã€ç®¡ç†èˆ‡åŠ å·¥ã€‚",
      skills: ["æ°´è³ªè§€å¯Ÿ", "é­šé¡ç…§è­·", "é¤µé£Ÿèˆ‡æ¸…æ½”", "è€å¿ƒèˆ‡ç´°å¿ƒ"]
    },
    "è³‡è¨Šç¾¤": {
      desc: "ç¨‹å¼è¨­è¨ˆã€ç¶²ç«™å»ºç½®ã€è³‡æ–™åº«èˆ‡ç¶²è·¯ç®¡ç†ã€‚",
      skills: ["é‚è¼¯æ€è€ƒ", "æ’°å¯«ç¨‹å¼", "è§£æ±ºå•é¡Œèƒ½åŠ›", "æŒçºŒå­¸ç¿’æ–°æŠ€è¡“"]
    }
  };

  const defaultAvatars = ["ğŸ»â€â„ï¸","ğŸ±","ğŸ°","ğŸ¦Š","ğŸ¼","ğŸ¶","ğŸ¸","ğŸ¯"];
  const tempAvatarImages = {}; // index -> dataURL

  const STORAGE_KEY = "careerSnakeLadder114_v5";

  const gameState = {
    started:false,
    players:[],
    board:[],
    currentPlayerIndex:0,
    questions:[],
    chanceCards:[],
    fateCards:[],
    winner:null,
    gameOver:false
  };

  const logStore = []; // {text, playerId}

  // ================== DOM ==================
  const setupCard = document.getElementById("setup-card");
  const gameCard = document.getElementById("game-card");
  const resultCard = document.getElementById("result-card");
  const resultContent = document.getElementById("resultContent");

  const playerCountSelect = document.getElementById("playerCount");
  const playerInputsEl = document.getElementById("playerInputs");
  const startGameBtn = document.getElementById("startGameBtn");
  const loadSavedGameBtn = document.getElementById("loadSavedGameBtn");
  const questionInput = document.getElementById("questionInput");
  const questionFileInput = document.getElementById("questionFileInput");
  const loadSampleQuestionsBtn = document.getElementById("loadSampleQuestionsBtn");

  const boardEl = document.getElementById("board");
  const playersTableBody = document.getElementById("playersTableBody");
  const currentTurnEl = document.getElementById("currentTurn");
  const logEl = document.getElementById("log");
  const logFilterSelect = document.getElementById("logFilterSelect");
  const rollDiceBtn = document.getElementById("rollDiceBtn");
  const saveGameBtn = document.getElementById("saveGameBtn");

  const diceOverlay = document.getElementById("diceOverlay");
  const dicePopup = document.getElementById("dicePopup");

  const modalOverlay = document.getElementById("modalOverlay");
  const modalIconEl = document.getElementById("modalIcon");
  const modalTitleEl = document.getElementById("modalTitle");
  const modalBodyEl = document.getElementById("modalBody");
  const modalButtonsEl = document.getElementById("modalButtons");

  // ================== ç©å®¶è¼¸å…¥æ¬„ä½ ==================
  function renderPlayerInputs() {
    const count = parseInt(playerCountSelect.value,10);
    playerInputsEl.innerHTML = "";
    for(let i=0;i<count;i++){
      const wrap = document.createElement("div");
      wrap.style.marginBottom = "6px";

      const nameLabel = document.createElement("label");
      nameLabel.textContent = `ç©å®¶ ${i+1} åç¨±`;
      const nameInput = document.createElement("input");
      nameInput.type="text";
      nameInput.id = `playerName${i}`;
      nameInput.value = `ç©å®¶${i+1}`;

      const avatarLabel = document.createElement("label");
      avatarLabel.textContent = `ç©å®¶ ${i+1} é ­åƒï¼ˆå¯ä¸Šå‚³åœ–ç‰‡ï¼‰`;
      avatarLabel.style.marginTop="4px";
      avatarLabel.style.fontWeight="500";

      const avatarInput = document.createElement("input");
      avatarInput.type="file";
      avatarInput.accept="image/*";
      avatarInput.id = `playerAvatar${i}`;
      avatarInput.style.fontSize="11px";

      avatarInput.addEventListener("change",(e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = evt => { tempAvatarImages[i] = evt.target.result; };
        reader.readAsDataURL(file);
      });

      wrap.appendChild(nameLabel);
      wrap.appendChild(nameInput);
      wrap.appendChild(avatarLabel);
      wrap.appendChild(avatarInput);
      playerInputsEl.appendChild(wrap);
    }
  }
  playerCountSelect.addEventListener("change", renderPlayerInputs);
  renderPlayerInputs();

  // ================== é¡Œåº«ç¤ºç¯„ ==================
  loadSampleQuestionsBtn.addEventListener("click",()=>{
    const sampleLines = [
      // æ©Ÿæ¢°ç¾¤
      "åŠ å·¥æ©Ÿå°å¸¸è¦‹æ–¼å“ªä¸€å€‹è·ç¾¤ï¼Ÿï½œæ©Ÿæ¢°ç¾¤ï½œå¤–èªç¾¤ï½œå®¶æ”¿ç¾¤ï½œé£Ÿå“ç¾¤ï½œæ©Ÿæ¢°ç¾¤ï½œæ©Ÿæ¢°ç¾¤",
      "æ“ä½œè»ŠåºŠéœ€è¦å…·å‚™ä»€éº¼èƒ½åŠ›ï¼Ÿï½œä½¿ç”¨æ©Ÿå™¨èˆ‡é‡æ¸¬å·¥å…·ï½œå¤–èªå£èªªï½œç…§é¡§å¹¼å…’ï½œæ¼”å¥æ¨‚å™¨ï½œä½¿ç”¨æ©Ÿå™¨èˆ‡é‡æ¸¬å·¥å…·ï½œæ©Ÿæ¢°ç¾¤",

      // å‹•åŠ›æ©Ÿæ¢°ç¾¤
      "ç¶­ä¿®è¾²ç”¨æ‹–æ‹‰æ©Ÿå±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤ï½œè¨­è¨ˆç¾¤ï½œè³‡è¨Šç¾¤ï½œå®¶æ”¿ç¾¤ï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤ï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤",
      "æª¢æŸ¥å¼•æ“ã€è¼ªèƒèˆ‡æ²¹è·¯ä¸»è¦æ˜¯å“ªå€‹ç¾¤çš„å·¥ä½œï¼Ÿï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤ï½œé£Ÿå“ç¾¤ï½œå¤–èªç¾¤ï½œæµ·äº‹ç¾¤ï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤ï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤",

      // é›»æ©Ÿèˆ‡é›»å­ç¾¤
      "å®‰è£é›»ç‡ˆèˆ‡æ’åº§å±¬æ–¼å“ªå€‹è·ç¾¤è¼ƒå¸¸è¦‹ï¼Ÿï½œé›»æ©Ÿèˆ‡é›»å­ç¾¤ï½œè¾²æ¥­ç¾¤ï½œé¤æ—…ç¾¤ï½œæ°´ç”¢ç¾¤ï½œé›»æ©Ÿèˆ‡é›»å­ç¾¤ï½œé›»æ©Ÿèˆ‡é›»å­ç¾¤",
      "è¨­è¨ˆé›»å­é›»è·¯æ¿éœ€è¦ä»€éº¼åŸºæœ¬èƒ½åŠ›ï¼Ÿï½œé–±è®€é›»è·¯åœ–ï½œçƒ¹é£ªæŠ€å·§ï½œå¤–èªç¿»è­¯ï½œç…§é¡§é­šé¡ï½œé–±è®€é›»è·¯åœ–ï½œé›»æ©Ÿèˆ‡é›»å­ç¾¤",

      // åŒ–å·¥ç¾¤
      "åŒ–å­¸å¯¦é©—å®¤æ“ä½œè—¥å“ã€ç›£æ¸¬åæ‡‰å±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œåŒ–å·¥ç¾¤ï½œè³‡è¨Šç¾¤ï½œå¤–èªç¾¤ï½œå®¶æ”¿ç¾¤ï½œåŒ–å·¥ç¾¤ï½œåŒ–å·¥ç¾¤",
      "æ“ä½œåŒ–å­¸è£½ç¨‹è¨­å‚™æ™‚ï¼Œæœ€é‡è¦çš„æ…‹åº¦æ˜¯ä»€éº¼ï¼Ÿï½œé‡è¦–å®‰å…¨èˆ‡é˜²è­·ï½œè¬›ç¬‘è©±ï½œè·‘æ­¥é€Ÿåº¦å¿«ï½œæœƒç•«æ¼«ç•«ï½œé‡è¦–å®‰å…¨èˆ‡é˜²è­·ï½œåŒ–å·¥ç¾¤",

      // åœŸæœ¨èˆ‡å»ºç¯‰ç¾¤
      "æ–½å·¥å·¥åœ°ä¸Šé‡æ¸¬åœ°åŸºé«˜åº¦èˆ‡è·é›¢å±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œåœŸæœ¨èˆ‡å»ºç¯‰ç¾¤ï½œé¤æ—…ç¾¤ï½œè¾²æ¥­ç¾¤ï½œè³‡è¨Šç¾¤ï½œåœŸæœ¨èˆ‡å»ºç¯‰ç¾¤ï½œåœŸæœ¨èˆ‡å»ºç¯‰ç¾¤",
      "ç›£å·¥ã€ç•«å¹³é¢åœ–ã€ä¸ˆé‡æ¨‘æŸ±æ˜¯ä¸‹åˆ—ä½•è€…çš„å·¥ä½œï¼Ÿï½œåœŸæœ¨èˆ‡å»ºç¯‰ç¾¤ï½œå¤–èªç¾¤ï½œé£Ÿå“ç¾¤ï½œå®¶æ”¿ç¾¤ï½œåœŸæœ¨èˆ‡å»ºç¯‰ç¾¤ï½œåœŸæœ¨èˆ‡å»ºç¯‰ç¾¤",

      // å•†æ¥­èˆ‡ç®¡ç†ç¾¤
      "æ«ƒå°çµå¸³ã€æ•´ç†è²¨æ¶ã€ä»‹ç´¹å•†å“å¸¸è¦‹æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤ï½œè¨­è¨ˆç¾¤ï½œè³‡è¨Šç¾¤ï½œæµ·äº‹ç¾¤ï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤ï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤",
      "å­¸æœƒè¨˜å¸³ã€é€²éŠ·è²¨ç®¡ç†èˆ‡é¡§å®¢æœå‹™æ˜¯ä½•ç¨®è·ç¾¤é‡é»ï¼Ÿï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤ï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤ï½œé£Ÿå“ç¾¤ï½œæ°´ç”¢ç¾¤ï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤ï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤",

      // å¤–èªç¾¤
      "åœ¨æ—…é¤¨è¿æ¥åœ‹å¤–æ—…å®¢ï¼Œéœ€è¦å¤§é‡ä½¿ç”¨å“ªä¸€ç¨®èƒ½åŠ›ï¼Ÿï½œå¤–èªæºé€šï½œæ©Ÿæ¢°åŠ å·¥ï½œé›»è·¯ç„Šæ¥ï½œç…§é¡§å¹¼å…’ï½œå¤–èªæºé€šï½œå¤–èªç¾¤",
      "ç¿»è­¯æ–‡ä»¶ã€å£è­¯å°è©±ã€å”åŠ©åœ‹éš›æºé€šæ˜¯ä½•ç¨®è·ç¾¤å°ˆé•·ï¼Ÿï½œå¤–èªç¾¤ï½œè³‡è¨Šç¾¤ï½œåŒ–å·¥ç¾¤ï½œå®¶æ”¿ç¾¤ï½œå¤–èªç¾¤ï½œå¤–èªç¾¤",

      // è¨­è¨ˆç¾¤
      "è¨­è¨ˆæµ·å ±èˆ‡ LOGO çš„å·¥ä½œä¸»è¦å±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œè¨­è¨ˆç¾¤ï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤ï½œè¾²æ¥­ç¾¤ï½œæµ·äº‹ç¾¤ï½œè¨­è¨ˆç¾¤ï½œè¨­è¨ˆç¾¤",
      "ä½¿ç”¨ç¹ªåœ–æ¿èˆ‡è¨­è¨ˆè»Ÿé«”æ’ç‰ˆå±¬æ–¼å“ªå€‹è·ç¾¤çš„é‡è¦æŠ€èƒ½ï¼Ÿï½œè¨­è¨ˆç¾¤ï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤ï½œé£Ÿå“ç¾¤ï½œæ°´ç”¢ç¾¤ï½œè¨­è¨ˆç¾¤ï½œè¨­è¨ˆç¾¤",

      // è¾²æ¥­ç¾¤
      "ç…§é¡§è”¬èœã€çŒæº‰èˆ‡é™¤è‰æ˜¯ä¸‹åˆ—å“ªå€‹è·ç¾¤çš„å·¥ä½œï¼Ÿï½œè¾²æ¥­ç¾¤ï½œå®¶æ”¿ç¾¤ï½œæµ·äº‹ç¾¤ï½œè³‡è¨Šç¾¤ï½œè¾²æ¥­ç¾¤ï½œè¾²æ¥­ç¾¤",
      "å­¸ç¿’å¦‚ä½•è®“ä½œç‰©å¥åº·æˆé•·ã€é‹ç”¨ç’°å¢ƒè³‡æºå±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œè¾²æ¥­ç¾¤ï½œåŒ–å·¥ç¾¤ï½œå¤–èªç¾¤ï½œé¤æ—…ç¾¤ï½œè¾²æ¥­ç¾¤ï½œè¾²æ¥­ç¾¤",

      // é£Ÿå“ç¾¤
      "é£Ÿå“å·¥å» é€²è¡Œå“ç®¡æª¢é©—ï¼Œä¸»è¦åœ¨æ„çš„æ˜¯ä»€éº¼ï¼Ÿï½œå®‰å…¨èˆ‡è¡›ç”Ÿï½œåŒ…è£é¡è‰²ï½œéŸ³æ¨‚å¤§å°è²ï½œé€Ÿåº¦å¿«æ…¢ï½œå®‰å…¨èˆ‡è¡›ç”Ÿï½œé£Ÿå“ç¾¤",
      "èª¿é…é£²æ–™ã€çƒ˜ç„™éºµåŒ…ã€æª¢æŸ¥ä¿å­˜æœŸé™èˆ‡å“ªå€‹è·ç¾¤æœ€ç›¸é—œï¼Ÿï½œé£Ÿå“ç¾¤ï½œè³‡è¨Šç¾¤ï½œæ©Ÿæ¢°ç¾¤ï½œæµ·äº‹ç¾¤ï½œé£Ÿå“ç¾¤ï½œé£Ÿå“ç¾¤",

      // å®¶æ”¿ç¾¤
      "è¦åŠƒå®¶åº­é£²é£Ÿã€æ•´ç†å±…å®¶ç’°å¢ƒã€ç…§é¡§å®¶åº­æˆå“¡æ˜¯ä½•ç¨®è·ç¾¤ï¼Ÿï½œå®¶æ”¿ç¾¤ï½œå¤–èªç¾¤ï½œè¨­è¨ˆç¾¤ï½œæ°´ç”¢ç¾¤ï½œå®¶æ”¿ç¾¤ï½œå®¶æ”¿ç¾¤",
      "å­¸ç¿’ç¸«ç´‰ã€ç°¡æ˜“ä¿®è£œèˆ‡ç”Ÿæ´»ç†è²¡å±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œå®¶æ”¿ç¾¤ï½œåœŸæœ¨èˆ‡å»ºç¯‰ç¾¤ï½œåŒ–å·¥ç¾¤ï½œè¾²æ¥­ç¾¤ï½œå®¶æ”¿ç¾¤ï½œå®¶æ”¿ç¾¤",

      // é¤æ—…ç¾¤
      "åœ¨é¤å»³ç«¯èœã€é»é¤èˆ‡æ¸…ç†æ¡Œé¢æ˜¯ä»€éº¼è·ç¾¤å¸¸è¦‹çš„å¯¦ç¿’å…§å®¹ï¼Ÿï½œé¤æ—…ç¾¤ï½œæ©Ÿæ¢°ç¾¤ï½œè³‡è¨Šç¾¤ï½œæ°´ç”¢ç¾¤ï½œé¤æ—…ç¾¤ï½œé¤æ—…ç¾¤",
      "å­¸ç¿’æ–™ç†èˆ‡æœå‹™æ—…å®¢æ˜¯ä»¥ä¸‹å“ªå€‹è·ç¾¤çš„é‡é»ï¼Ÿï½œé¤æ—…ç¾¤ï½œåŒ–å·¥ç¾¤ï½œæµ·äº‹ç¾¤ï½œè¾²æ¥­ç¾¤ï½œé¤æ—…ç¾¤ï½œé¤æ—…ç¾¤",

      // æµ·äº‹ç¾¤
      "åœ¨èˆ¹ä¸Šå­¸ç¿’èˆªè¡Œèˆ‡æ“ä½œèˆ¹èˆ¶å±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œæµ·äº‹ç¾¤ï½œå•†æ¥­èˆ‡ç®¡ç†ç¾¤ï½œé£Ÿå“ç¾¤ï½œå®¶æ”¿ç¾¤ï½œæµ·äº‹ç¾¤ï½œæµ·äº‹ç¾¤",
      "é–±è®€èˆªæµ·åœ–ã€ç¶­è­·èˆ¹èˆ¶è¨­å‚™æ˜¯ä¸‹åˆ—å“ªå€‹è·ç¾¤ç›¸é—œèƒ½åŠ›ï¼Ÿï½œæµ·äº‹ç¾¤ï½œè¨­è¨ˆç¾¤ï½œè³‡è¨Šç¾¤ï½œå‹•åŠ›æ©Ÿæ¢°ç¾¤ï½œæµ·äº‹ç¾¤ï½œæµ·äº‹ç¾¤",

      // æ°´ç”¢ç¾¤
      "ç…§é¡§é­šé¡ã€æ¸…ç†é­šæ± èˆ‡ç›£æ¸¬æ°´è³ªå±¬æ–¼å“ªä¸€å€‹è·ç¾¤ï¼Ÿï½œæ°´ç”¢ç¾¤ï½œè¾²æ¥­ç¾¤ï½œé¤æ—…ç¾¤ï½œè³‡è¨Šç¾¤ï½œæ°´ç”¢ç¾¤ï½œæ°´ç”¢ç¾¤",
      "å­¸ç¿’é¤Šæ®–æŠ€è¡“èˆ‡æµ·æ´‹è³‡æºåˆ©ç”¨æ˜¯ä½•ç¨®è·ç¾¤å…§å®¹ï¼Ÿï½œæ°´ç”¢ç¾¤ï½œåŒ–å·¥ç¾¤ï½œå¤–èªç¾¤ï½œå®¶æ”¿ç¾¤ï½œæ°´ç”¢ç¾¤ï½œæ°´ç”¢ç¾¤",

      // è³‡è¨Šç¾¤
      "æ’°å¯«ç¨‹å¼ã€æ¸¬è©¦ APPã€ç®¡ç†è³‡æ–™åº«å±¬æ–¼å“ªå€‹è·ç¾¤ï¼Ÿï½œè³‡è¨Šç¾¤ï½œé¤æ—…ç¾¤ï½œæµ·äº‹ç¾¤ï½œå®¶æ”¿ç¾¤ï½œè³‡è¨Šç¾¤ï½œè³‡è¨Šç¾¤",
      "å­¸ç¿’ç¨‹å¼èªè¨€èˆ‡é›»è…¦ç¶²è·¯ï¼Œæ˜¯å“ªä¸€å€‹è·ç¾¤çš„é‡è¦èƒ½åŠ›ï¼Ÿï½œè³‡è¨Šç¾¤ï½œè¾²æ¥­ç¾¤ï½œé£Ÿå“ç¾¤ï½œå¤–èªç¾¤ï½œè³‡è¨Šç¾¤ï½œè³‡è¨Šç¾¤"
    ];
    questionInput.value = sampleLines.join("\n");
    parseQuestionsFromText();
    alert("å·²è¼‰å…¥ç¤ºç¯„é¡Œåº«ï¼ˆæ¯å€‹è·ç¾¤å„ 2 é¡Œï¼‰ã€‚");
  });

  // CSV åŒ¯å…¥ï¼ˆé¡Œç›®, A, B, C, D, ç­”æ¡ˆ, è·ç¾¤ï¼‰
  questionFileInput.addEventListener("change",(e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt=>{
      const text = evt.target.result;
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const rows = [];
      for(const line of lines){
        let parts;
        if(line.includes("ï½œ")) parts = line.split("ï½œ");
        else if(line.includes(",")) parts = line.split(",");
        else if(line.includes("\t")) parts = line.split("\t");
        else continue;
        if(parts.length<7) continue;
        rows.push(parts.map(p=>p.trim()).join("ï½œ"));
      }
      if(!rows.length){
        alert("åŒ¯å…¥å¤±æ•—ï¼šæ¯è¡Œéœ€è‡³å°‘ 7 æ¬„ï¼ˆé¡Œç›®ã€4 é¸é …ã€ç­”æ¡ˆã€è·ç¾¤åˆ†é¡ï¼‰");
      return;
      }
      questionInput.value = rows.join("\n");
      parseQuestionsFromText();
      alert(`å·²æˆåŠŸåŒ¯å…¥ ${rows.length} é¡Œã€‚`);
    };
    reader.readAsText(file,"utf-8");
  });

  // è§£æé¡Œåº«æ–‡å­—
  function parseQuestionsFromText(){
    const text = questionInput.value.trim();
    if(!text){
      gameState.questions = [];
      return;
    }
    const lines = text.split(/\r?\n/);
    const qs = [];
    for(const line of lines){
      const parts = line.split("ï½œ").map(p=>p.trim());
      if(parts.length < 7) continue;
      const [q,a,b,c,d,ans,cat] = parts;
      if(!q || !cat) continue;
      qs.push({
        question:q,
        options:[a,b,c,d],
        answer:ans,
        category:cat
      });
    }
    gameState.questions = qs;
  }

  // ================== æ£‹ç›¤å»ºç«‹ï¼š100 æ ¼è›‡æ¢¯ ==================
  function createBoard(){
    const tiles = [];
    for(let i=1;i<=100;i++){
      tiles.push({ id:i, type:"subject", category:null, story:null });
    }

    // æ©Ÿæœƒèˆ‡å‘½é‹æ ¼
    const chancePositions = [5,18,32,44,59,73,86];
    const fatePositions   = [10,23,37,52,66,79,92];

    chancePositions.forEach(pos=>{
      const t = tiles[pos-1];
      t.type="chance";
      t.category=null;
      t.story = "è·å ´æ©Ÿæœƒï¼šæœ‰æ™‚å€™å¹¸é‹æœƒçªç„¶å‡ºç¾ï¼Œçœ‹çœ‹é€™æ¬¡æœƒå¸¶ä¾†ä»€éº¼æ”¹è®Šã€‚";
    });
    fatePositions.forEach(pos=>{
      const t = tiles[pos-1];
      t.type="fate";
      t.category=null;
      t.story = "äººç”Ÿå‘½é‹ï¼šæœ‰äº›äº‹æƒ…ä¸åœ¨è¨ˆç•«å…§ï¼Œä½†å¯ä»¥æˆç‚ºæˆé•·çš„å¥‘æ©Ÿã€‚";
    });

    // è›‡èˆ‡æ¢¯å­ï¼ˆçœŸå¯¦äººç”Ÿäº‹ä»¶ï¼‰
    const ladders = [
      {from:3,to:22, story:"ä½ é–‹å§‹é¤Šæˆå›ºå®šå¯«ä½œæ¥­èˆ‡é ç¿’çš„ç¿’æ…£ï¼Œæˆç¸¾é€²æ­¥ï¼Œäººç”Ÿå¾€ä¸Šçˆ¬ä¸€éšã€‚"},
      {from:8,to:26, story:"ä½ ä¸»å‹•åƒåŠ æŠ€è—æ•™è‚²èª²ç¨‹ï¼Œå­¸åˆ°æ–°æŠ€èƒ½ï¼Œæ‰¾åˆ°å‰é€²çš„éšæ¢¯ã€‚"},
      {from:15,to:34, story:"ä½ å’Œè€å¸«è¨è«–æœªä¾†æ–¹å‘ï¼Œè¨‚ä¸‹ç›®æ¨™ï¼Œå¾€æ›´æ¸…æ¥šçš„äººç”Ÿéšæ®µå‰é€²ã€‚"},
      {from:28,to:47, story:"ä½ åƒåŠ æ¯”è³½å¾—åˆ°ä½³ä½œï¼Œå»ºç«‹è‡ªä¿¡ï¼Œå‹‡æ•¢å¾€å‰è·¨ä¸€å¤§æ­¥ã€‚"},
      {from:36,to:55, story:"ä½ é–‹å§‹ç©©å®šç”¨ç·šä¸Šå¹³å°å­¸ç¿’ï¼ŒæŒçºŒç´¯ç©å¯¦åŠ›ï¼Œå‘ä¸Šçˆ¬å‡ã€‚"}
    ];
    const snakes = [
      {from:31,to:12, story:"ä½ å¸¸å¸¸ç¿¹èª²ã€å¿˜è¨˜å¸¶æ±è¥¿ï¼Œå­¸ç¿’é€²åº¦è½å¾Œï¼Œåªå¥½å¾€å›é€€ã€‚"},
      {from:49,to:25, story:"æ²‰è¿·æ‰‹æ©Ÿèˆ‡éŠæˆ²ï¼Œä½œæ¥­æ²’äº¤ï¼Œæˆç¸¾ä¸‹æ»‘ï¼Œè¢«è¿«é‡ä¾†ã€‚"},
      {from:62,to:40, story:"ä½ åœ¨é—œéµæ™‚åˆ»æ”¾æ£„ç·´ç¿’ï¼ŒéŒ¯å¤±ä¸Šå°è¡¨ç¾æ©Ÿæœƒï¼Œç‹€æ…‹å¾€ä¸‹æ‰ã€‚"},
      {from:74,to:53, story:"èˆ‡åŒå­¸ç™¼ç”Ÿè¡çªåˆä¸é¡˜å’Œè§£ï¼Œäººéš›æ°£æ°›è®Šå·®ï¼Œå¿ƒæƒ…æ»‘è½ã€‚"},
      {from:97,to:70, story:"è‡¨é–€ä¸€è…³å»é¬†æ‡ˆï¼Œæ²’æœ‰å …æŒåˆ°æœ€å¾Œï¼Œé›¢ç›®æ¨™åˆé äº†ä¸€é»ã€‚"}
    ];
    ladders.forEach(l=>{
      const t = tiles[l.from-1];
      t.type="ladder";
      t.to = l.to;
      t.story = l.story;
    });
    snakes.forEach(s=>{
      const t = tiles[s.from-1];
      t.type="snake";
      t.to = s.to;
      t.story = s.story;
    });

    // çµ‚é»
    tiles[99].type = "goal";
    tiles[99].story = "ä½ åŠªåŠ›ç¶“æ­·äº†äººç”Ÿçš„å„ç¨®éšæ®µï¼Œå¸¶è‘—ç´¯ç©çš„ç¶“é©—èµ°åˆ° 100 æ­²ã€‚";

    // å‰©ä¸‹ subject æ ¼åˆ†é…è·ç¾¤
    let index = 0;
    for(const t of tiles){
      if(t.type==="subject"){
        t.category = GROUPS[index % GROUPS.length];
        index++;
      }
    }
    return tiles;
  }

  // ================== æ©Ÿæœƒ / å‘½é‹å¡ ==================
  function createChanceCards(){
    return [
      {text:"ä½ åœ¨å¯¦ç¿’ä¸­ä¸»å‹•å¹«å¿™ï¼Œè€å¸«çµ¦ä½ å°çå‹µï¼Œè·æ¶¯åˆ†æ•¸ +10ã€‚", score:+10},
      {text:"ä½ åƒåŠ äº†ä¸€å ´å¾ˆæ£’çš„è·æ¶¯è¬›åº§ï¼Œç²å¾—å•Ÿç™¼ï¼Œè·æ¶¯åˆ†æ•¸ +15ã€‚", score:+15},
      {text:"å› ç‚ºé²åˆ°è¢«æé†’ï¼Œè·æ¶¯åˆ†æ•¸ -5ã€‚", score:-5},
      {text:"å¹«åŒå­¸å®Œæˆä¸€ä»½ä½œæ¥­ï¼Œè€å¸«ç¨±è®šä½ ï¼Œè·æ¶¯åˆ†æ•¸ +8ã€‚", score:+8},
      {text:"èº«é«”ä¸èˆ’æœï¼Œéœ€å¤šä¼‘æ¯ï¼Œä¸‹å›åˆè·³éä¸€æ¬¡ã€‚", skip:true}
    ];
  }
  function createFateCards(){
    return [
      {text:"ä½ å®Œæˆäº†ä¸€ä»½ç”Ÿæ¶¯èˆˆè¶£é‡è¡¨ï¼Œå°è‡ªå·±æ›´äº†è§£ï¼Œè·æ¶¯åˆ†æ•¸ +12ã€‚", score:+12},
      {text:"ä½ å’Œå®¶äººåµæ¶ï¼Œæƒ…ç·’å—å½±éŸ¿ï¼Œè·æ¶¯åˆ†æ•¸ -6ã€‚", score:-6},
      {text:"ä½ ä¸»å‹•å’Œè€å¸«è«‡æœªä¾†æ–¹å‘ï¼Œè·æ¶¯åˆ†æ•¸ +10ã€‚", score:+10},
      {text:"å› ç‚ºå¿ƒæƒ…ä¸å¥½æ²’æœ‰äº¤ä½œæ¥­ï¼Œè·æ¶¯åˆ†æ•¸ -8ã€‚", score:-8},
      {text:"ä½ åƒåŠ æŠ€è—æ•™è‚²èª²ç¨‹ï¼Œå­¸åˆ°æ–°æŠ€èƒ½ï¼Œè·æ¶¯åˆ†æ•¸ +15ã€‚", score:+15}
    ];
  }

  // ================== Modal å·¥å…· ==================
  function showModal(config){
    const {icon="ğŸ´", title="", html="", buttons=[]} = config;
    modalIconEl.textContent = icon;
    modalTitleEl.textContent = title;
    modalBodyEl.innerHTML = html;
    modalButtonsEl.innerHTML = "";
    buttons.forEach(cfg=>{
      const btn = document.createElement("button");
      btn.className = "modal-btn " + (cfg.variant||"secondary");
      btn.textContent = cfg.label;
      btn.addEventListener("click",()=>{
        hideModal();
        if(cfg.onClick) cfg.onClick();
      });
      modalButtonsEl.appendChild(btn);
    });
    modalOverlay.style.display = "flex";
  }
  function hideModal(){
    modalOverlay.style.display = "none";
  }

  function showInfoModal(icon,title,text,onClose){
    showModal({
      icon,
      title,
      html:`<p>${text.replace(/\n/g,"<br>")}</p>`,
      buttons:[{label:"å¥½",variant:"primary",onClick:onClose||(()=>{})}]
    });
  }

  // â˜…â˜… é¡Œç›®å½ˆçª—ï¼šä¸é¡¯ç¤ºè·ç¾¤åç¨±ï¼Œåªé¡¯ç¤ºé¡Œç›®èˆ‡é¸é … â˜…â˜…
  function showQuestionModal(player,tile,question,onResult){
    const opts = [...question.options];
    shuffleArray(opts);

    const html = `
      <div class="modal-image">ğŸ“</div>
      <p style="margin-top:4px;">${question.question}</p>
      <p style="font-size:11px;color:#6b7280;">è«‹é¸æ“‡ä¸€å€‹æœ€é©åˆçš„ç­”æ¡ˆã€‚</p>
    `;
    modalIconEl.textContent = "â“";
    modalTitleEl.textContent = `${player.name} çš„é¸æ“‡é¡Œ`;
    modalBodyEl.innerHTML = html;
    modalButtonsEl.innerHTML = "";
    opts.forEach(opt=>{
      const btn = document.createElement("button");
      btn.className = "modal-btn option";
      btn.textContent = opt;
      btn.addEventListener("click",()=>{
        hideModal();
        onResult(opt, question.answer);
      });
      modalButtonsEl.appendChild(btn);
    });
    modalOverlay.style.display = "flex";
  }

  function showGroupInfoModal(tile){
    const cat = tile.category;
    if(!cat || !groupInfo[cat]) return;
    const info = groupInfo[cat];
    const emoji = groupEmoji[cat] || "ğŸ’¼";
    const skillsHtml = info.skills.map(s=>`<li>${s}</li>`).join("");
    const html = `
      <div class="modal-image">${emoji}</div>
      <p><b>${cat}</b></p>
      <p style="margin-top:4px;">${info.desc}</p>
      <p style="margin-top:6px;font-weight:600;">é€™å€‹è·ç¾¤éœ€è¦çš„æŠ€èƒ½ï¼š</p>
      <ul style="margin:4px 0 0 18px;font-size:13px;">${skillsHtml}</ul>
    `;
    showModal({
      icon:"ğŸ“š",
      title:`è·ç¾¤ä»‹ç´¹ï¼š${cat}`,
      html,
      buttons:[{label:"äº†è§£",variant:"primary"}]
    });
  }

  // ================== å·¥å…· ==================
  function randomItem(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
  }

  function addLog(msg, playerId=null){
    const time = new Date().toLocaleTimeString("zh-TW",{hour12:false});
    const textWithTime = `[${time}] ${msg}`;
    logStore.unshift({ text:textWithTime, playerId });

    // åŒæ™‚è¨˜åˆ°ç©å®¶è‡ªå·±çš„äº‹ä»¶ç´€éŒ„
    if(playerId !== null){
      const player = gameState.players.find(p=>p.id===playerId);
      if(player){
        if(!player.events) player.events = [];
        player.events.push(msg); // ä¸åŠ æ™‚é–“ï¼Œæ–¹ä¾¿é–±è®€
      }
    }

    renderLog();
    renderResults(); // è‹¥å·²çµæŸå¯å³æ™‚æ›´æ–°ç•«é¢
  }

  function renderLog(){
    const filter = logFilterSelect.value;
    logEl.innerHTML = "";
    logStore.forEach(entry=>{
      if(filter!=="all" && String(entry.playerId)!==filter) return;
      const div = document.createElement("div");
      div.textContent = entry.text;
      logEl.appendChild(div);
    });
  }

  function populateLogFilter(){
    const cur = logFilterSelect.value;
    logFilterSelect.innerHTML = `<option value="all">å…¨éƒ¨ç©å®¶</option>`;
    gameState.players.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = p.name;
      logFilterSelect.appendChild(opt);
    });
    logFilterSelect.value = cur || "all";
  }
  logFilterSelect.addEventListener("change", renderLog);

  // ================== çµæŸç•«é¢æ¸²æŸ“ ==================
  function renderResults(){
    if(!gameState.gameOver){
      resultCard.style.display = "none";
      return;
    }
    resultCard.style.display = "block";

    if(!gameState.players || !gameState.players.length){
      resultContent.innerHTML = "";
      return;
    }

    let html = "";
    gameState.players.forEach(p=>{
      const avatarHtml = p.avatarImage
        ? `<span style="display:inline-block;width:24px;height:24px;border-radius:999px;overflow:hidden;vertical-align:middle;"><img src="${p.avatarImage}" style="width:100%;height:100%;object-fit:cover;"></span>`
        : `<span>${p.avatarEmoji}</span>`;
      html += `<div class="result-player">
        <h3>${avatarHtml}<span>${p.name}</span></h3>
        <p style="font-size:12px;color:#4b5563;margin:0 0 2px 0;">
          æœ€å¾Œä½ç½®ï¼š${p.position === 100 ? "100ï¼ˆçµ‚é»ï¼‰" : p.position || "èµ·é»"}ï¼Œ
          è·æ¶¯åˆ†æ•¸ï¼š${p.score}
        </p>`;

      const events = p.events || [];
      if(events.length){
        html += `<ul>${events.map(e=>`<li>${e}</li>`).join("")}</ul>`;
      }else{
        html += `<p style="font-size:12px;color:#9ca3af;margin:2px 0 0;">ï¼ˆå°šæœªè¨˜éŒ„äº‹ä»¶ï¼‰</p>`;
      }
      html += `</div>`;
    });

    resultContent.innerHTML = html;
  }

  // ================== æ£‹ç›¤åº§æ¨™ ==================
  function tileNumberAt(row,col){
    const n = 10;
    const rowFromBottom = 9 - row; // 0 = bottom row
    const isEven = rowFromBottom % 2 === 0;
    if(isEven){
      return rowFromBottom * n + col + 1;
    }else{
      return rowFromBottom * n + (n - col);
    }
  }

  function renderBoard(){
    boardEl.innerHTML = "";
    const n = 10;

    const playersByPos = {};
    gameState.players.forEach(p=>{
      if(p.position>0){
        if(!playersByPos[p.position]) playersByPos[p.position] = [];
        playersByPos[p.position].push(p);
      }
    });

    for(let r=0;r<n;r++){
      for(let c=0;c<n;c++){
        const cell = document.createElement("div");
        cell.className = "board-cell";

        const num = tileNumberAt(r,c);
        const tile = gameState.board[num-1];

        cell.dataset.tileId = String(tile.id);

        const numEl = document.createElement("div");
        numEl.className = "tile-number";
        numEl.textContent = num === 100 ? "100 æ­²" : num;
        cell.appendChild(numEl);

        if(tile.type === "subject"){
          const catEl = document.createElement("div");
          catEl.className = "tile-category";
          catEl.textContent = tile.category || "";
          cell.appendChild(catEl);
          const typeEl = document.createElement("div");
          typeEl.className = "tile-type";
          typeEl.textContent = "é»æ“Šå¯çœ‹è·ç¾¤ä»‹ç´¹ï¼å›ç­”é¡Œç›®";
          cell.appendChild(typeEl);
        }else{
          const typeEl = document.createElement("div");
          typeEl.className = "tile-type";
          if(tile.type==="chance") typeEl.textContent = "ğŸ€ æ©Ÿæœƒ";
          else if(tile.type==="fate") typeEl.textContent = "ğŸ”® å‘½é‹";
          else if(tile.type==="ladder"){
            typeEl.textContent = `ğŸŒˆ å¾€ä¸Šçˆ¬åˆ° ${tile.to}`;
          }else if(tile.type==="snake"){
            typeEl.textContent = `ğŸ’§ æ»‘è½åˆ° ${tile.to}`;
          }else if(tile.type==="goal"){
            typeEl.textContent = "ğŸ† 100 æ­²çµ‚é»";
          }
          cell.appendChild(typeEl);
        }

        const tilePlayers = playersByPos[num] || [];
        if(tilePlayers.length){
          const tokenWrap = document.createElement("div");
          tokenWrap.className = "token-wrap";
          const p = tilePlayers[0];
          const token = document.createElement("div");
          token.className = "token";
          if(p.avatarImage){
            const img = document.createElement("img");
            img.src = p.avatarImage;
            token.appendChild(img);
          }else{
            token.textContent = p.avatarEmoji;
          }
          tokenWrap.appendChild(token);
          cell.appendChild(tokenWrap);
        }

        boardEl.appendChild(cell);
      }
    }
  }

  // é»æ ¼å­ï¼šè·ç¾¤ä»‹ç´¹æˆ–äººç”Ÿäº‹ä»¶
  boardEl.addEventListener("click",(e)=>{
    const cell = e.target.closest(".board-cell");
    if(!cell) return;
    const id = parseInt(cell.dataset.tileId,10);
    const tile = gameState.board.find(t=>t.id===id);
    if(!tile) return;
    if(tile.type==="subject" && tile.category){
      showGroupInfoModal(tile);
    }else if(tile.type==="ladder" || tile.type==="snake"){
      if(tile.story){
        const icon = tile.type==="ladder" ? "ğŸŒˆ" : "ğŸ’§";
        const title = tile.type==="ladder" ? "äººç”Ÿçš„å‘ä¸Šéšæ¢¯" : "äººç”Ÿçš„å°æ»‘è½";
        showInfoModal(icon, title, tile.story);
      }
    }
  });

  // ================== ç©å®¶å€æ¸²æŸ“ ==================
  function renderPlayers(){
    playersTableBody.innerHTML = "";
    const current = gameState.players[gameState.currentPlayerIndex];
    currentTurnEl.textContent = gameState.winner
      ? `ğŸ† éŠæˆ²çµæŸï¼š${gameState.winner.name} æŠµé” 100 æ­²ï¼`
      : `ğŸ¯ ç¾åœ¨è¼ªåˆ°ï¼š${current.name}`;

    gameState.players.forEach(p=>{
      const tr = document.createElement("tr");

      const avatarTd = document.createElement("td");
      if(p.avatarImage){
        avatarTd.innerHTML = `<span style="display:inline-block;width:24px;height:24px;border-radius:999px;overflow:hidden;vertical-align:middle;"><img src="${p.avatarImage}" style="width:100%;height:100%;object-fit:cover;"></span>`;
      }else{
        avatarTd.textContent = p.avatarEmoji;
      }

      const nameTd = document.createElement("td");
      nameTd.textContent = p.name;

      const posTd = document.createElement("td");
      posTd.textContent = p.position === 0 ? "èµ·é»" : p.position;

      const scoreTd = document.createElement("td");
      scoreTd.textContent = p.score;

      tr.appendChild(avatarTd);
      tr.appendChild(nameTd);
      tr.appendChild(posTd);
      tr.appendChild(scoreTd);

      playersTableBody.appendChild(tr);
    });
  }

  function renderAll(){
    renderBoard();
    renderPlayers();
    populateLogFilter();
    renderLog();
    renderResults();
  }

  // ================== é–‹å§‹éŠæˆ² ==================
  startGameBtn.addEventListener("click",()=>{
    const count = parseInt(playerCountSelect.value,10);
    const players = [];
    for(let i=0;i<count;i++){
      const nameInput = document.getElementById(`playerName${i}`);
      const name = (nameInput?.value || "").trim() || `ç©å®¶${i+1}`;
      players.push({
        id:i,
        name,
        avatarEmoji:defaultAvatars[i%defaultAvatars.length],
        avatarImage:tempAvatarImages[i] || null,
        position:0,
        score:0,
        skipNext:false,
        events:[]
      });
    }

    parseQuestionsFromText();
    if(!gameState.questions.length){
      if(!confirm("ç›®å‰é¡Œåº«æ˜¯ç©ºçš„ï¼Œç¢ºå®šè¦åœ¨æ²’æœ‰é¡Œç›®çš„æƒ…æ³ä¸‹é–‹å§‹å—ï¼Ÿ")) return;
    }

    gameState.players = players;
    gameState.board = createBoard();
    gameState.currentPlayerIndex = 0;
    gameState.chanceCards = createChanceCards();
    gameState.fateCards = createFateCards();
    gameState.started = true;
    gameState.winner = null;
    gameState.gameOver = false;

    logStore.length = 0;
    addLog("éŠæˆ²é–‹å§‹ï¼å¾ 0 æ­²å‡ºç™¼ï¼Œçœ‹çœ‹èª°èƒ½æœ€å…ˆèµ°åˆ° 100 æ­²ã€‚");
    setupCard.style.display = "none";
    gameCard.style.display = "block";
    renderAll();
    checkSavedGameButton();
    saveGameState();
  });

  // ================== æ£‹å­ç§»å‹•å‹•ç•« ==================
  function animateMove(player, targetPos, onComplete){
    function step(){
      if(player.position === targetPos){
        renderAll();
        if(onComplete) onComplete();
        return;
      }
      player.position += 1;
      renderAll();
      setTimeout(step, 250); // æ¯æ­¥ 0.25 ç§’
    }
    step();
  }

  // ================== æ“²éª°å­æµç¨‹ ==================
  rollDiceBtn.addEventListener("click",()=>{
    if(!gameState.started || gameState.winner) return;
    const player = gameState.players[gameState.currentPlayerIndex];

    if(player.skipNext){
      addLog(`${player.name} æœ¬å›åˆéœ€è¦ä¼‘æ¯ä¸€æ¬¡ã€‚`, player.id);
      player.skipNext = false;
      nextTurn();
      saveGameState();
      return;
    }

    rollDiceBtn.disabled = true;
    let counter = 0;
    diceOverlay.style.display = "flex";
    const timer = setInterval(()=>{
      const r = Math.floor(Math.random()*6)+1;
      dicePopup.textContent = r;
      counter++;
      if(counter>=10){
        clearInterval(timer);
        const finalRoll = Math.floor(Math.random()*6)+1;
        dicePopup.textContent = finalRoll;
        addLog(`${player.name} æ“²å‡º ${finalRoll} é»ã€‚`, player.id);
        setTimeout(()=>{
          diceOverlay.style.display = "none";
          executeRoll(player, finalRoll);
        },300);
      }
    },80);
  });

  function executeRoll(player,steps){
    const target = player.position + steps;
    if(target > 100){
      addLog(`${player.name} è¶…é 100 æ­²ï¼Œéœ€å‰›å¥½è¸©åˆ° 100ï¼Œåœåœ¨åŸåœ°ã€‚`, player.id);
      renderAll();
      nextTurn();
      saveGameState();
      return;
    }
    // å‹•ç•«ä¸€æ ¼ä¸€æ ¼ç§»å‹•åˆ° target
    animateMove(player, target, ()=>{
      addLog(`${player.name} ç§»å‹•åˆ° ${target} æ ¼ã€‚`, player.id);
      const tile = gameState.board[target-1];
      handleTile(player, tile);
    });
  }

  // ================== è™•ç†æ ¼å­äº‹ä»¶ ==================
  function handleTile(player,tile){
    if(tile.type === "goal"){
      gameState.winner = player;
      gameState.gameOver = true;
      addLog(`${player.name} æŠµé” 100 æ­²ï¼ŒæˆåŠŸå®Œæˆé€™è¶Ÿäººç”Ÿè·æ¶¯æ—…ç¨‹ï¼`, player.id);
      showInfoModal("ğŸ†","éŠæˆ²çµæŸ",
        `${player.name} é †åˆ©æŠµé” 100 æ­²æ ¼ï¼\nå¯ä»¥è«‹å­¸ç”Ÿåˆ†äº«ï¼šåœ¨é€™è¶Ÿæ—…ç¨‹ä¸­ï¼Œå“ªä¸€æ ¼ã€å“ªä¸€é¡Œæœ€è®“ä½ å°è±¡æ·±åˆ»ï¼Ÿ`,
        ()=>{ renderAll(); rollDiceBtn.disabled=true; }
      );
      renderAll();
      saveGameState();
      return;
    }

    if(tile.type === "ladder"){
      const msg = tile.story || `${player.name} è¸©åˆ°å¥½ç¿’æ…£çš„éšæ¢¯ï¼Œå¾€ä¸Šçˆ¬åˆ° ${tile.to}ã€‚`;
      addLog(msg, player.id);
      showInfoModal("ğŸŒˆ","äººç”Ÿçš„å‘ä¸Šéšæ¢¯", msg, ()=>{
        player.position = tile.to;
        addLog(`${player.name} è¢«æ¢¯å­å¸¶åˆ° ${tile.to} æ ¼ã€‚`, player.id);
        const nextTile = gameState.board[tile.to-1];
        handleTile(player,nextTile);
      });
      return;
    }

    if(tile.type === "snake"){
      const msg = tile.story || `${player.name} è¸©åˆ°è®“è‡ªå·±ç‹€æ…‹ä¸‹æ»‘çš„å°å¤±èª¤ï¼Œæ»‘è½åˆ° ${tile.to}ã€‚`;
      addLog(msg, player.id);
      showInfoModal("ğŸ’§","äººç”Ÿçš„å°æ»‘è½", msg, ()=>{
        player.position = tile.to;
        addLog(`${player.name} è¢«æ»‘è½åˆ° ${tile.to} æ ¼ã€‚`, player.id);
        const nextTile = gameState.board[tile.to-1];
        handleTile(player,nextTile);
      });
      return;
    }

    if(tile.type === "chance"){
      const card = randomItem(gameState.chanceCards);
      const msg = card.text;
      addLog(`${player.name} æŠ½åˆ°æ©Ÿæœƒå¡ï¼š${card.text}`, player.id);
      showInfoModal("ğŸ€","æ©Ÿæœƒå¡", msg, ()=>{
        if(card.score){
          player.score += card.score;
          addLog(`${player.name} è·æ¶¯åˆ†æ•¸è®Šå‹•ï¼š${card.score>0?"+":""}${card.score}`, player.id);
        }
        if(card.skip){
          player.skipNext = true;
          addLog(`${player.name} ä¸‹å›åˆéœ€è¦ä¼‘æ¯ä¸€æ¬¡ã€‚`, player.id);
        }
        renderAll();
        nextTurn();
        saveGameState();
      });
      return;
    }

    if(tile.type === "fate"){
      const card = randomItem(gameState.fateCards);
      const msg = card.text;
      addLog(`${player.name} æŠ½åˆ°å‘½é‹å¡ï¼š${card.text}`, player.id);
      showInfoModal("ğŸ”®","å‘½é‹å¡", msg, ()=>{
        if(card.score){
          player.score += card.score;
          addLog(`${player.name} è·æ¶¯åˆ†æ•¸è®Šå‹•ï¼š${card.score>0?"+":""}${card.score}`, player.id);
        }
        renderAll();
        nextTurn();
        saveGameState();
      });
      return;
    }

    // subject æ ¼ï¼ˆå›ç­”å°æ‡‰è·ç¾¤é¡Œç›®ï¼‰
    if(tile.type === "subject"){
      const cat = tile.category;
      const catQuestions = gameState.questions.filter(q=>q.category===cat);
      let chosen;
      if(catQuestions.length){
        chosen = randomItem(catQuestions);
      }else if(gameState.questions.length){
        chosen = randomItem(gameState.questions);
      }

      if(!chosen){
        addLog(`${player.name} åœåœ¨ ${cat||"ä¸€èˆ¬"} æ ¼ï¼Œä½†ç›®å‰ç„¡é¡Œåº«ï¼Œç›´æ¥çµæŸå›åˆã€‚`, player.id);
        renderAll();
        nextTurn();
        saveGameState();
        return;
      }

      showQuestionModal(player,tile,chosen,(chosenAnswer,correctAnswer)=>{
        if(chosenAnswer.trim() === correctAnswer.trim()){
          addLog(`${player.name} åœ¨é¡Œç›®ä¸­ç­”å°ï¼Œè·æ¶¯åˆ†æ•¸ +10ã€‚`, player.id);
          player.score += 10;
          renderAll();
          nextTurn();
          saveGameState();
        }else{
          addLog(`${player.name} åœ¨é¡Œç›®ä¸­ç­”éŒ¯ï¼Œé€€å› 1 æ ¼ä¸¦è·æ¶¯åˆ†æ•¸ -5ã€‚`, player.id);
          player.score -= 5;
          player.position = Math.max(1, player.position - 1);
          renderAll();
          nextTurn();
          saveGameState();
        }
      });
    }
  }

  function nextTurn(){
    gameState.currentPlayerIndex = (gameState.currentPlayerIndex+1) % gameState.players.length;
    renderAll();
    rollDiceBtn.disabled = false;
  }

  // ================== å„²å­˜ï¼è¼‰å…¥é€²åº¦ ==================
  function saveGameState(){
    if(!gameState.started) return;
    const data = {
      players: gameState.players,
      currentPlayerIndex: gameState.currentPlayerIndex,
      questionsText: questionInput.value,
      gameOver: gameState.gameOver,
      winnerId: gameState.winner ? gameState.winner.id : null
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  saveGameBtn.addEventListener("click",()=>{
    saveGameState();
    alert("éŠæˆ²é€²åº¦å·²å„²å­˜ã€‚");
    checkSavedGameButton();
  });

  function checkSavedGameButton(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      loadSavedGameBtn.style.display = "inline-flex";
    }
  }
  checkSavedGameButton();

  loadSavedGameBtn.addEventListener("click",()=>{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      alert("ç›®å‰æ²’æœ‰å„²å­˜çš„éŠæˆ²ã€‚");
      return;
    }
    try{
      const data = JSON.parse(raw);
      gameState.players = (data.players || []).map(p=>({
        ...p,
        events: p.events || []
      }));
      gameState.board = createBoard();
      gameState.currentPlayerIndex = data.currentPlayerIndex || 0;
      questionInput.value = data.questionsText || "";
      parseQuestionsFromText();
      gameState.chanceCards = createChanceCards();
      gameState.fateCards = createFateCards();
      gameState.started = true;
      gameState.gameOver = !!data.gameOver;
      if(data.winnerId !== null && data.winnerId !== undefined){
        gameState.winner = gameState.players.find(p=>p.id===data.winnerId) || null;
      }else{
        gameState.winner = null;
      }

      logStore.length = 0;
      addLog("å·²è¼‰å…¥ä¸Šæ¬¡éŠæˆ²é€²åº¦ã€‚");
      setupCard.style.display = "none";
      gameCard.style.display = "block";
      renderAll();
      rollDiceBtn.disabled = !!gameState.gameOver;
    }catch(e){
      alert("è¼‰å…¥å¤±æ•—ï¼Œè³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚");
    }
  });

  // ================== åˆå§‹åŒ– ==================
  function renderInitial(){
    renderPlayerInputs();
  }
  renderInitial();
</script>
</body>
</html>
